ROSTemplateFormatVersion: '2015-09-01'
Description:
  en: ecs部署nginx
  zh-cn: ecs部署nginx
# 参数配置
Parameters:
  PayType:
    Type: String
    Label:
      en: ECS Instance Charge Type
      zh-cn: 付费类型
    Default: PostPaid
    AllowedValues:
      - PostPaid
      - PrePaid
    AssociationProperty: ChargeType
    AssociationPropertyMetadata:
      LocaleKey: InstanceChargeType
  PayPeriodUnit:
    Type: String
    Label:
      en: Pay Period Unit
      zh-cn: 购买资源时长周期
    Default: Month
    AllowedValues:
      - Month
      - Year
    AssociationProperty: PayPeriodUnit
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Not:
            Fn::Equals:
              - ${PayType}
              - PostPaid
  PayPeriod:
    Type: Number
    Description:
      en: When the resource purchase duration is Month, the value of Period ranges from 1 to 9, 12, 24, 36, 48, or 60. <br><b><font color='red'> When ECS instance types are PrePaid valid </b></font>
      zh-cn: 当购买资源时长为Month时，Period取值：1~9 <br><b><font color='red'>当ECS实例类型为PrePaid有效</b></font>
    Label:
      en: Period
      zh-cn: 购买资源时长
    Default: 1
    AllowedValues:
      - 1
      - 2
      - 3
      - 4
      - 5
      - 6
      - 7
      - 8
      - 9
    AssociationProperty: PayPeriod
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Not:
            Fn::Equals:
              - ${PayType}
              - PostPaid
  ZoneId:
    Type: String
    AssociationProperty: ALIYUN::ECS::Instance::ZoneId
    Label:
      en: VSwitch Availability Zone
      zh-cn: 交换机可用区
  # 新建ack所在的vpc的网段
  VpcCidrBlock:
    Type: String
    Label:
      en: VPC CIDR IPv4 Block
      zh-cn: 专有网络IPv4网段
    Description:
      zh-cn: VPC的ip地址段范围，<br>您可以使用以下的ip地址段或其子网:<br><font color='green'>[10.0.0.0/8]</font><br><font color='green'>[172.16.0.0/12]</font><br><font color='green'>[192.168.0.0/16]</font>
      en: 'The ip address range of the VPC in the CidrBlock form; <br>You can use the following ip address ranges and their subnets: <br><font color=''green''>[10.0.0.0/8]</font><br><font color=''green''>[172.16.0.0/12]</font><br><font color=''green''>[192.168.0.0/16]</font>'
    Default: 192.168.0.0/16
    AssociationProperty: ALIYUN::VPC::VPC::CidrBlock
  # 新建ack所在的交换机的网段
  VSwitchCidrBlock:
    Type: String
    Label:
      en: VSwitch CIDR Block
      zh-cn: 交换机子网网段
    Description:
      zh-cn: 必须属于VPC的子网段。
      en: Must belong to the subnet segment of VPC.
    Default: 192.168.1.0/24
    AssociationProperty: ALIYUN::VPC::VSwitch::CidrBlock
    AssociationPropertyMetadata:
      VpcCidrBlock: VpcCidrBlock
  EcsInstanceType:
    Type: String
    Label:
      en: Instance Type
      zh-cn: 实例类型
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
    AssociationPropertyMetadata:
      ZoneId: ${ZoneId}
      InstanceChargeType: ${InstanceChargeType}
    AllowedValues:
      - ecs.gn7i-c8g1.2xlarge
      - ecs.gn7i-c16g1.4xlarge
      - ecs.gn7i-c32g1.8xlarge
  InstancePassword:
    NoEcho: true
    Type: String
    Description:
      en: Server login password, Length 8-30, must contain three(Capital letters, lowercase letters, numbers, !@#$%^&*()_+-= Special symbol in)
      zh-cn: 服务器登录密码,长度8-30，必须包含三项（大写字母、小写字母、数字、 !@#$%^&*()_+-= 中的特殊符号）
    AllowedPattern: '[0-9A-Za-z\_\-\&:;''<>,=%`~!@#\(\)\$\^\*\+\|\{\}\[\]\.\?\/]+$'
    Label:
      en: Instance Password
      zh-cn: 实例密码
    ConstraintDescription:
      en: Length 8-30, must contain three(Capital letters, lowercase letters, numbers, !@#$%^&*()_+-= Special symbol in)
      zh-cn: 长度8-30，必须包含三项（大写字母、小写字母、数字、 !@#$%^&*()_+-= 中的特殊符号）
    MinLength: 8
    MaxLength: 30
    AssociationProperty: ALIYUN::ECS::Instance::Password
  RedisPassword:
    NoEcho: true
    Type: String
    Description:
      en: Server login password, Length 8-30, must contain three(Capital letters, lowercase letters, numbers Special symbol in)
      zh-cn: 服务器登录密码,长度8-30，必须包含三项（大写字母、小写字母、数字）
    Label:
      en: Instance Password
      zh-cn: 实例密码
    ConstraintDescription:
      en: Length 8-30, must contain three(Capital letters, lowercase letters, numbers, !@#$%^&*()_+-=  Special symbol in)
      zh-cn: 长度8-30，必须包含三项（大写字母、小写字母、数字）
    AllowedPattern: '^[a-zA-Z0-9]*$'
    MinLength: 8
    MaxLength: 30
    Default: 'pleasechangeThis'
  UserName:
    Type: String
    Label:
      en: User Name
      zh-cn: 软件登录名
    Default: admin
  Password:
    NoEcho: true
    Type: String
    Description:
      en: Software login password, Length 8-30, must contain three(Capital letters, lowercase letters, numbers, !@#$%^&*()_+-= Special symbol in)
      zh-cn: 软件登录密码
    AllowedPattern: '[0-9A-Za-z\_\-\&:;''<>,=%`~!@#\(\)\$\^\*\+\|\{\}\[\]\.\?\/]+$'
    Label:
      en: Software Login Password
      zh-cn: 软件登录密码
    ConstraintDescription:
      en: Length 8-30, must contain three(Capital letters, lowercase letters, numbers, !@#$%^&*()_+-= Special symbol in)
      zh-cn: 长度8-30，必须包含三项（大写字母、小写字母、数字、 !@#$%^&*()_+-= 中的特殊符号）
    MinLength: 8
    MaxLength: 30
    AssociationProperty: ALIYUN::ECS::Instance::Password
  PluginGitUrl:
    Type: String
    Label:
      en: PluginGitUrl
      zh-cn: PluginGitUrl
    Description:
      en: ChatGLM-6B model weight git download address, please copy to https://huggingface.co/THUDM/chatglm-6b input box, it will be downloaded to the /root/chatglm directory. [Alibaba cloud is not responsible for the third party you use on the mirror The legality, safety, and accuracy of the model are guaranteed, and you are not responsible for any damages arising therefrom; you should consciously abide by the user agreement, usage specifications, and relevant laws and regulations of the third-party models installed on the mirror, and take responsibility for You are solely responsible for the legality and compliance of using third-party models. Please consciously abide by https://huggingface.co/THUDM/chatglm-6b/blob/main/MODEL_LICENSE agreement]
      zh-cn: ChatGLM-6B模型权重git下载地址，请拷贝https://huggingface.co/THUDM/chatglm-6b 到输入框，将下载至/root/chatglm目录下. 【阿里云不对您在镜像上使用的第三方模型的合法性、安全性、准确性进行任何保证，并不对由此引发的任何损害承担责任；您应自觉遵守在镜像上安装的第三方模型的用户协议、使用规范和相关法律法规，并就使用第三方模型的合法性、合规性自行承担相关责任。请自觉遵守https://huggingface.co/THUDM/chatglm-6b/blob/main/MODEL_LICENSE协议】
  InstanceClass:
    Type: String
    Label:
      en: Tair InstanceClass
      zh-cn: 实例规格
    Default: tair.rdb.2g
    AllowedValues:
      - tair.rdb.2g
      - tair.rdb.4g
      - tair.rdb.8g
      - tair.rdb.16g
      - tair.rdb.32g
Resources:
  # 新建vpc
  EcsVpc:
    Type: ALIYUN::ECS::VPC
    Properties:
      VpcName:
        Ref: ALIYUN::StackName
      CidrBlock:
        Ref: VpcCidrBlock
  # 新建vswitch
  EcsVSwitch:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      VSwitchName:
        Ref: ALIYUN::StackName
      VpcId:
        Ref: EcsVpc
      ZoneId:
        Ref: ZoneId
      CidrBlock:
        Ref: VSwitchCidrBlock
  EcsSecurityGroup:
    Type: ALIYUN::ECS::SecurityGroup
    Properties:
      SecurityGroupName:
        Ref: ALIYUN::StackName
      VpcId:
        Ref: EcsVpc
      # 安全组入端口
      SecurityGroupIngress:
        - PortRange: 5000/5000
          Priority: 1
          SourceCidrIp: 0.0.0.0/0
          IpProtocol: tcp
          NicType: internet
      # 安全组出端口
      SecurityGroupEgress:
        - PortRange: '-1/-1'
          Priority: 1
          IpProtocol: all
          DestCidrIp: 0.0.0.0/0
          NicType: internet
        - PortRange: '-1/-1'
          Priority: 1
          IpProtocol: all
          DestCidrIp: 0.0.0.0/0
          NicType: intranet
  # 定义waitCondition和waitConditionHandle来等待跳板机命令执行完毕部署成功
  WaitCondition:
    Type: ALIYUN::ROS::WaitCondition
    Properties:
      Count: 1
      Handle:
        Ref: WaitConditionHandle
      Timeout: 1800
    DependsOn:
      - RedisInstance
      - RedisWhitelist
  WaitConditionHandle:
    Type: ALIYUN::ROS::WaitConditionHandle
  EcsInstanceGroup:
    Type: ALIYUN::ECS::InstanceGroup
    Properties:
      # 实例名
      InstanceName:
        Fn::Join:
          - '-'
          - - Ref: ALIYUN::StackName
            - '[1,4]'
      IoOptimized: optimized
      # 付费类型
      InstanceChargeType:
        Ref: PayType
      PeriodUnit:
        Ref: PayPeriodUnit
      Period:
        Ref: PayPeriod
      # 网络配置
      VpcId:
        Ref: EcsVpc
      ZoneId:
        Ref: ZoneId
      VSwitchId:
        Ref: EcsVSwitch
      SecurityGroupId:
        Ref: EcsSecurityGroup
      # 磁盘类型和大小
      SystemDiskCategory: cloud_essd
      SystemDiskSize: 500
      MaxAmount: 1
      # 镜像
      ImageId: centos_7
      # 实例类型
      InstanceType:
        Ref: EcsInstanceType
      Password:
        Ref: InstancePassword
      # 公网开启
      AllocatePublicIP: true
      # 公网带宽
      InternetMaxBandwidthOut: 20
  # redis 实例配置
  RedisInstance:
    Type: ALIYUN::REDIS::Instance
    Properties:
      VpcId:
        Ref: EcsVpc
      VSwitchId:
        Ref: EcsVSwitch
      InstanceClass: 
        Ref: InstanceClass
      EngineVersion: '6.0'
      ChargeType:
        Ref: PayType
      Period:
        Ref: PayPeriod
      PeriodUnit:
        Ref: PayPeriodUnit
      TairConfig:
        StorageType: essd_pl1
        ShardCount: 2
      EvictionPolicy: 'noeviction'
      ZoneId:
        Ref: ZoneId
      InstanceName:
        Ref: ALIYUN::StackName
      Password:
        Ref: InstancePassword
  RedisWhitelist:
    Type: ALIYUN::REDIS::Whitelist
    Properties:
      InstanceId:
        Fn::GetAtt:
          - RedisInstance
          - InstanceId
      SecurityIps:
        Fn::Join:
          - ','
          - Fn::GetAtt:
              - EcsInstanceGroup
              - PrivateIps
  # 到机器上执行命令
  InstanceRunCommand:
    Type: ALIYUN::ECS::RunCommand
    DependsOn:
      - RedisWhitelist
      - RedisInstance
    Properties:
      Sync: true
      CommandContent:
        Fn::Sub:
          # 将master的ip输入到/root/conf.txt
          # 可以在后续的步骤中通过conf.txt里的内容完成slave的初始化
          - |
            #!/bin/bash
            for ((i=0;i<100;i++))
            do
              rm -rf /root/chatglm && mkdir -p /root/chatglm && cd /root/chatglm && git lfs clone ${PluginGitUrl}
              glmsize=`ls /root/chatglm/chatglm-6b | wc -l`
              if [[ -d "/root/chatglm/chatglm-6b" && $glmsize -gt 8 ]]
              then
                break
              fi
            sleep 3
            done
            unset TAIR_URL
            echo ${RedisConnectionString} ${RedisConnectionPort} ${RedisPassword}
            export REDIS_HOST=${RedisConnectionString}
            export REDIS_PORT=${RedisConnectionPort}
            export REDIS_PASSWORD=${RedisPassword}
            export TAIR_URL=redis://default:${RedisPassword}@${RedisConnectionString}:${RedisConnectionPort}
            echo  "export TAIR_URL=redis://default:${RedisPassword}@${RedisConnectionString}:${RedisConnectionPort}" > /etc/environment
            # first start
            nohup /root/miniconda3/bin/python /root/langchain-ChatGLM/chatbot.py > /var/log/chat-glm.log 2>&1 &

            for ((i=0;i<100;i++))
            do
              curl 127.0.0.1:5001
              if [ "$?" == 0 ]
              then
                break
              fi
            sleep 3
            done

            # reboot 
            systemctl enable chat-glm
            # nginx
            htpasswd -bc /etc/nginx/password ${UserName} '${Password}'
            systemctl start nginx
            systemctl status nginx
            systemctl enable nginx
            # 执行成功回调WaitCondition结束waitCondition的等待
            ${CurlCli} -d "{\"Data\" : \"Success\", \"status\" : \"SUCCESS\"}"
          - RedisPassword:
              Ref: RedisPassword
            # 从Database的Output中拿到内网连接串
            RedisConnectionString:
              Fn::GetAtt:
                - RedisInstance
                - VpcPrivateConnectionString
            RedisConnectionPort:
              Fn::GetAtt:
                - RedisInstance
                - VpcPrivateConnectionPort
            UserName:
              Ref: UserName
            Password:
              Ref: Password
            # 获取到waitConditionHandle的地址放到 ${CurlCli}变量里
            CurlCli:
              Fn::GetAtt:
                - WaitConditionHandle
                - CurlCli
      Type: RunShellScript
      InstanceIds:
        Fn::GetAtt:
          - EcsInstanceGroup
          - InstanceIds
      # 超时时间
      Timeout: '2400'
# 定义输出
Outputs:
  # 将公网ip做为http返回的地址显示在控制台
  Endpoint:
    Description:
      zh-cn: 对外暴露的公网IP地址
      en: Public IP Addresses
    Value:
      Fn::Sub:
        - http://${ServerAddress}:5000
        - ServerAddress:
            Fn::Select:
              - 0
              - Fn::GetAtt:
                 - EcsInstanceGroup
                 - PublicIps
  PrivateEndpoint:
    Description:
      zh-cn: 内网IP地址
      en: Public IP Addresses
    Value:
      Fn::Sub:
        - http://${ServerAddress}:5000
        - ServerAddress:
            Fn::Select:
              - 0
              - Fn::GetAtt:
                  - EcsInstanceGroup
                  - PrivateIps

Metadata:
  ALIYUN::ROS::Interface:
    # 分组信息
    ParameterGroups:
      - Parameters:
          - PayType
          - PayPeriodUnit
          - PayPeriod
        Label:
          default:
            en: PayType Configuration
            zh-cn: 付费类型配置
      - Parameters:
          - EcsInstanceType
          - InstancePassword
        Label:
          default:
            en: Instance
            zh-cn: ECS实例配置
      - Parameters:
          - UserName
          - Password
          - PluginGitUrl
        Label:
          default:
            en: Model Configuration
            zh-cn: 模型配置
      - Parameters:
          - RedisPassword
          - InstanceClass
        Label:
          default:
            en: Tair
            zh-cn: Tair
      - Parameters:
          - ZoneId
        Label:
          default:
            zh-cn: 可用区配置
            en: Zone Configuration
      - Parameters:
          - VpcCidrBlock
          - VSwitchCidrBlock
        Label:
          default:
            zh-cn: 选择网络配置
            en: Choose existing Infrastructure Configuration